import{K as j,d as re,r as g,e as p,c as x,o as _,b as e,h as r,w as a,F as q,y as K,q as T,i as se,k as $,O as S,S as ae,B as _e,L as be,N as H,z as J,t as Ae,A as Q,x as Ve,H as ye,p as Ie}from"./index-CDtMGLGq.js";import{s as Le,g as Ue}from"./index-bVW4JEgj.js";import{u as oe,g as ke,C as we}from"./index-B7bU3Lwl.js";import{b as he}from"./index-RazWJMKj.js";const Pe=(I,L,R)=>j.get(`/admin/product/${I}/${L}`,{params:R}),Ce=I=>I.id?j.post("/admin/product/updateSpuInfo",I):j.post("/admin/product/saveSpuInfo",I),xe=I=>j.delete(`/admin/product/deleteSpu/${I}`),ne=I=>j.get(`/admin/product/spuImageList/${I}`),de=I=>j.get(`/admin/product/spuSaleAttrList/${I}`),De=()=>j.get("/admin/product/baseSaleAttrList"),Ne=["src"],$e=re({__name:"skuForm",emits:["changeScene"],setup(I,{expose:L,emit:R}){let D=R;const z=oe(),s=()=>({category3Id:void 0,spuId:void 0,tmId:void 0,skuName:"",skuDesc:"",price:void 0,skuDefaultImg:"",skuAttrValueList:[],skuSaleAttrValueList:[],skuImageList:[],weight:""});let o=g(s()),N=g(),U=g([]),b=g([]),P=g([]),V=g();const k=async()=>{const n=await ke(z.c1Id,z.c2Id,o.value.category3Id);n.code===ae?U.value=n.data:S.error("获取平台属性失败");const i=await de(o.value.spuId);i.code===ae?b.value=i.data:S.error("获取销售属性失败");const u=await ne(o.value.spuId);u.code===ae?P.value=u.data:S.error("获取spu图片失败")},w=n=>{o.value=s(),Object.assign(o.value,{category3Id:n.category3Id,spuId:n.id,tmId:n.tmId}),k()},h={skuName:[{required:!0,message:"请输入SKU名称",trigger:"blur"}],price:[{required:!0,message:"请输入SKU价格",trigger:"blur"}],weight:[{required:!0,message:"请输入重量",trigger:"blur"}],skuDesc:[{required:!0,message:"请输入SKU描述",trigger:"blur"}],skuAttrValueList:[{required:!0,validator:(n,i,u)=>{U.value.length===0?u(new Error("至少选择一项平台属性")):(U.value.some(C=>C.valueId!==void 0)||u(new Error("至少选择一项平台属性")),u())},trigger:"blur"}],skuSaleAttrValueList:[{required:!0,validator:(n,i,u)=>{b.value.length===0?u(new Error("至少选择一项销售属性")):(b.value.some(C=>C.saleAttrValueId!==void 0)||u(new Error("至少选择一项销售属性")),u())},trigger:"blur"}],skuDefaultImg:[{required:!0,validator:(n,i,u)=>{o.value.skuDefaultImg===void 0||o.value.skuDefaultImg===""?u(new Error("至少上传一张图片")):u()},trigger:"blur"}]},X=n=>{V.value.clearSelection(),V.value.toggleRowSelection(n),o.value.skuDefaultImg=n.imgUrl},M=()=>{N.value.validate(async n=>{if(!n){S.error("请检查输入项");return}o.value.skuAttrValueList=U.value.filter(u=>u.valueId).map(u=>({attrId:u.id,valueId:u.valueId})),o.value.skuSaleAttrValueList=b.value.filter(u=>u.saleAttrValueId).map(u=>({saleAttrId:u.id,saleAttrValueId:u.saleAttrValueId})),(await Le(o.value)).code===ae?(S.success("保存成功"),D("changeScene",0)):S.error("保存失败")})},m=()=>{D("changeScene",0)};return L({initAddData:w}),(n,i)=>{const u=p("el-input"),A=p("el-form-item"),C=p("el-option"),O=p("el-select"),G=p("el-form"),E=p("el-table-column"),B=p("el-button"),y=p("el-table");return _(),x("div",null,[e(G,{model:r(o),ref_key:"addOrUpdateSkuFormRef",ref:N,rules:h,"label-width":"110px"},{default:a(()=>[e(A,{label:"SKU名称",prop:"skuName"},{default:a(()=>[e(u,{modelValue:r(o).skuName,"onUpdate:modelValue":i[0]||(i[0]=c=>r(o).skuName=c),placeholder:"请输入SKU名称",clearable:""},null,8,["modelValue"])]),_:1}),e(A,{label:"SKU价格(元)",prop:"price"},{default:a(()=>[e(u,{modelValue:r(o).price,"onUpdate:modelValue":i[1]||(i[1]=c=>r(o).price=c),type:"number",placeholder:"请输入sku价格",clearable:""},null,8,["modelValue"])]),_:1}),e(A,{label:"重量(g)",prop:"weight"},{default:a(()=>[e(u,{modelValue:r(o).weight,"onUpdate:modelValue":i[2]||(i[2]=c=>r(o).weight=c),type:"number",placeholder:"请输入重量",clearable:""},null,8,["modelValue"])]),_:1}),e(A,{label:"SKU描述",prop:"skuDesc"},{default:a(()=>[e(u,{modelValue:r(o).skuDesc,"onUpdate:modelValue":i[3]||(i[3]=c=>r(o).skuDesc=c),type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"请输入SKU描述",clearable:""},null,8,["modelValue"])]),_:1}),e(A,{label:"平台属性",prop:"skuAttrValueList"},{default:a(()=>[e(G,{inline:!0},{default:a(()=>[(_(!0),x(q,null,K(r(U),(c,l)=>(_(),T(A,{key:c.id,label:c.attrName},{default:a(()=>[e(O,{modelValue:r(U)[l].valueId,"onUpdate:modelValue":t=>r(U)[l].valueId=t,placeholder:"请选择",style:{width:"100px"},clearable:""},{default:a(()=>[(_(!0),x(q,null,K(c.attrValueList,t=>(_(),T(C,{key:t.id,label:t.valueName,value:t.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),128))]),_:1})]),_:1}),e(A,{label:"销售属性",prop:"skuSaleAttrValueList"},{default:a(()=>[e(G,{inline:!0},{default:a(()=>[(_(!0),x(q,null,K(r(b),(c,l)=>(_(),T(A,{key:c.id,label:c.saleAttrName},{default:a(()=>[e(O,{modelValue:r(b)[l].saleAttrValueId,"onUpdate:modelValue":t=>r(b)[l].saleAttrValueId=t,placeholder:"请选择",clearable:"",style:{width:"100px"}},{default:a(()=>[(_(!0),x(q,null,K(c.spuSaleAttrValueList,t=>(_(),T(C,{key:t.id,label:t.saleAttrValueName,value:t.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),128))]),_:1})]),_:1}),e(A,{label:"图片名称",prop:"skuDefaultImg"},{default:a(()=>[e(y,{ref_key:"spuImageListTableRef",ref:V,data:r(P),border:"",stripe:""},{default:a(()=>[e(E,{type:"selection"}),e(E,{prop:"id",label:"图片"},{default:a(c=>[se("img",{src:c.row.imgUrl,alt:"",style:{width:"100px",height:"100px"}},null,8,Ne)]),_:1}),e(E,{prop:"imgName",label:"名称"}),e(E,{label:"操作"},{default:a(c=>[e(B,{type:"primary",size:"default",onClick:l=>X(c.row)},{default:a(()=>i[4]||(i[4]=[$(" 设置默认 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(A,null,{default:a(()=>[e(B,{type:"primary",onClick:M},{default:a(()=>i[5]||(i[5]=[$("保存")])),_:1}),e(B,{onClick:m},{default:a(()=>i[6]||(i[6]=[$("取消")])),_:1})]),_:1})]),_:1},8,["model"])])}}}),Re={style:{padding:"20px"}},ze=["src"],Fe=re({__name:"spuForm",emits:["changeScene"],setup(I,{expose:L,emit:R}){let D=R;const z=()=>({category3Id:void 0,description:"",id:void 0,spuImageList:[],spuName:"",spuSaleAttrList:[],tmId:void 0});let s=g(z());const o=g();let N=g([]),U=g([]),b=g(""),P=g(!1),V=g([]),k=g(),w=g("");_e(async()=>{let l=await he();l.code===200?N.value=l.data:S.error("获取所有的品牌信息失败");let t=await De();t.code===200?U.value=t.data:S.error("获取所有的销售属性信息失败")});const ee=l=>{s.value.category3Id=l,V.value=[]},te=async l=>{s.value=l;let t=await ne(s.value.id);t.code===200?V.value=t.data.map(v=>({name:v.imgName,url:v.imgUrl})):S.error("获取SPU图片列表失败");let f=await de(s.value.id);f.code===200?s.value.spuSaleAttrList=f.data:S.error("获取SPU销售属性信息失败")},W=async l=>{b.value=l.url,P.value=!0},h=()=>{},X=()=>{var l;(l=o.value)==null||l.validateField("spuImageList")},M=l=>l.type!=="image/jpeg"&&l.type!=="image/png"&&l.type!=="image/jpg"&&l.type!=="image/gif"?(S.error("只能上传 JPG/PNG/GIF 文件"),!1):l.size/1024/1024>4?(S.error("图片大小不能超过 4MB"),!1):!0,m=be(()=>U.value.filter(l=>{var t;return!((t=s.value.spuSaleAttrList)!=null&&t.some(f=>f.baseSaleAttrId===l.id))})),n=()=>{var l,t;k.value&&(s.value.spuSaleAttrList.push({baseSaleAttrId:k.value,saleAttrName:(l=U.value.find(f=>f.id===k.value))==null?void 0:l.name,spuSaleAttrValueList:[],spuId:s.value.id}),k.value=void 0,(t=o.value)==null||t.validateField("spuSaleAttrList"))},i=(l,t)=>{s.value.spuSaleAttrList[l].spuSaleAttrValueList.splice(t,1)},u=l=>{s.value.spuSaleAttrList[l].showAddBtn=!0},A=l=>{if(!w.value||w.value.trim()===""){S.error("属性值不能为空");return}if(s.value.spuSaleAttrList[l].spuSaleAttrValueList.some(t=>t.saleAttrValueName===w.value)){S.error("属性值已存在");return}s.value.spuSaleAttrList[l].spuSaleAttrValueList.push({saleAttrValueName:w.value,baseSaleAttrId:s.value.spuSaleAttrList[l].baseSaleAttrId}),s.value.spuSaleAttrList[l].showAddBtn=!1,w.value=""},C=l=>{s.value.spuSaleAttrList.splice(l,1)},O=l=>{Ve(()=>{l==null||l.focus()})},B={spuName:[{required:!0,message:"SPU名称不能为空",trigger:"blur"}],tmId:[{required:!0,message:"SPU品牌不能为空",trigger:"blur"}],description:[{required:!0,message:"SPU描述不能为空",trigger:"blur"}],spuImageList:[{required:!0,validator:(l,t,f)=>{V.value.length===0?f(new Error("请上传SPU图片")):f()},trigger:"blur"}],spuSaleAttrList:[{required:!0,validator:(l,t,f)=>{if(s.value.spuSaleAttrList.length===0)f(new Error("请添加SPU销售属性"));else{for(let v=0;v<s.value.spuSaleAttrList.length;v++)if(!s.value.spuSaleAttrList[v].spuSaleAttrValueList||s.value.spuSaleAttrList[v].spuSaleAttrValueList.length===0){f(new Error("请添加SPU第"+(v+1)+"行销售属性值"));return}f()}},trigger:"blur"}]},y=()=>{o.value.validate(async l=>{if(!l){S.error("请填写完整的SPU信息");return}s.value.spuImageList=[];for(let f=0;f<V.value.length;f++){const v=V.value[f];let Y=v.url;v.response&&(Y=v.response.data),s.value.spuImageList.push({imgName:v.name,imgUrl:Y})}(await Ce(s.value)).code===200?(S.success("保存成功"),D("changeScene",0)):S.error("保存失败")})},c=()=>{s.value=z(),D("changeScene",0)};return L({initUpdateSpuParams:te,initAddSpuParams:ee}),(l,t)=>{const f=p("el-input"),v=p("el-form-item"),Y=p("el-option"),ue=p("el-select"),ie=p("Plus"),pe=p("el-icon"),me=p("el-upload"),ce=p("el-dialog"),Z=p("el-button"),le=p("el-table-column"),ge=p("el-tag"),fe=p("el-table"),Se=p("el-form");return _(),x("div",Re,[e(Se,{ref_key:"addOrUpdateSpuFormRef",ref:o,model:r(s),"label-width":"120px",rules:B},{default:a(()=>[e(v,{label:"SPU名称",prop:"spuName"},{default:a(()=>[e(f,{modelValue:r(s).spuName,"onUpdate:modelValue":t[0]||(t[0]=d=>r(s).spuName=d)},null,8,["modelValue"])]),_:1}),e(v,{label:"SPU品牌",prop:"tmId"},{default:a(()=>[e(ue,{modelValue:r(s).tmId,"onUpdate:modelValue":t[1]||(t[1]=d=>r(s).tmId=d),clearable:"",filterable:""},{default:a(()=>[(_(!0),x(q,null,K(r(N),d=>(_(),T(Y,{key:d.id,label:d.tmName,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"SPU描述",prop:"description"},{default:a(()=>[e(f,{type:"textarea",modelValue:r(s).description,"onUpdate:modelValue":t[2]||(t[2]=d=>r(s).description=d),autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1}),e(v,{label:"SPU图片",prop:"spuImageList"},{default:a(()=>[e(me,{"file-list":r(V),"onUpdate:fileList":t[3]||(t[3]=d=>H(V)?V.value=d:V=d),action:"/api/admin/product/fileUpload","list-type":"picture-card","on-preview":W,"on-remove":h,"on-success":X,"before-upload":M},{default:a(()=>[e(pe,null,{default:a(()=>[e(ie)]),_:1})]),_:1},8,["file-list"]),e(ce,{modelValue:r(P),"onUpdate:modelValue":t[4]||(t[4]=d=>H(P)?P.value=d:P=d)},{default:a(()=>[se("img",{"w-full":"",src:r(b),alt:"Preview Image",style:{width:"100%",height:"100%"}},null,8,ze)]),_:1},8,["modelValue"])]),_:1}),e(v,{label:"SPU销售属性",prop:"spuSaleAttrList"},{default:a(()=>[e(ue,{modelValue:r(k),"onUpdate:modelValue":t[5]||(t[5]=d=>H(k)?k.value=d:k=d),clearable:"",filterable:"",style:{width:"240px","margin-right":"10px"},placeholder:`还有${m.value.length}个销售属性可选`},{default:a(()=>[(_(!0),x(q,null,K(m.value,d=>(_(),T(Y,{key:d.id,label:d.name,value:d.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"]),e(Z,{type:"primary",size:"default",onClick:n,disabled:!r(k),icon:"Plus"},{default:a(()=>t[7]||(t[7]=[$(" 添加销售属性 ")])),_:1},8,["disabled"]),e(fe,{data:r(s).spuSaleAttrList,border:"",stripe:"",style:{margin:"10px 0"}},{default:a(()=>[e(le,{type:"index",label:"序号",width:"80px"}),e(le,{prop:"saleAttrName",label:"销售属性名字",width:"120px"}),e(le,{label:"销售属性值"},{default:a(d=>[(_(!0),x(q,null,K(d.row.spuSaleAttrValueList,(F,ve)=>(_(),T(ge,{key:F.id,size:"small",effect:"dark",closable:"",onClose:Oe=>i(d.$index,ve),style:{margin:"0 5px"}},{default:a(()=>[$(Ae(F.saleAttrValueName),1)]),_:2},1032,["onClose"]))),128)),J(e(f,{ref:O,modelValue:r(w),"onUpdate:modelValue":t[6]||(t[6]=F=>H(w)?w.value=F:w=F),placeholder:"请填写属性值",size:"small",clearable:"",onBlur:F=>A(d.$index),style:{width:"100px"}},null,8,["modelValue","onBlur"]),[[Q,d.row.showAddBtn]]),J(e(Z,{type:"primary",size:"small",icon:"Plus",onClick:F=>u(d.$index)},null,8,["onClick"]),[[Q,!d.row.showAddBtn]])]),_:1}),e(le,{label:"操作",width:"80px"},{default:a(d=>[e(Z,{type:"danger",size:"small",icon:"Delete",onClick:F=>C(d.$index)},null,8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(v,null,{default:a(()=>[e(Z,{type:"primary",onClick:y},{default:a(()=>t[8]||(t[8]=[$("保存")])),_:1}),e(Z,{onClick:c},{default:a(()=>t[9]||(t[9]=[$("取消")])),_:1})]),_:1})]),_:1},8,["model"])])}}}),Te=re({__name:"index",setup(I){const L=oe();ye(()=>{L.$reset()});let R=g(1),D=g(3),z=g(0),s=g([]),o=g(0),N=g(),U=g();const b=async m=>{if(!m)return;let n=await Pe(R.value,D.value,{category3Id:m});n.code===200?(z.value=n.data.total,s.value=n.data.records):(console.error("获取SPU列表失败"),S.error("获取SPU列表失败"))};Ie(()=>L.c3Id,async m=>{if(!m){s.value=[];return}b(m)});const P=()=>{N.value.initAddSpuParams(L.c3Id),o.value=1},V=m=>{D.value=m,b(L.c3Id)},k=m=>{R.value=m,b(L.c3Id)},w=async m=>{(await xe(m)).code===200?(S.success("删除SPU成功"),b(L.c3Id)):S.error("删除SPU失败")},ee=m=>{U.value.initAddData(m.row),o.value=2},te=m=>{N.value.initUpdateSpuParams(m.row),o.value=1};let W=g([]),h=g(!1);const X=async m=>{let n=await Ue(m.id);n.code===200?(W.value=n.data,h.value=!0):S.error("获取SPU详情失败")},M=m=>{o.value=m,b(L.c3Id)};return(m,n)=>{const i=p("el-button"),u=p("el-table-column"),A=p("el-popconfirm"),C=p("el-pagination"),O=p("el-table"),G=p("el-card"),E=p("el-image"),B=p("el-dialog");return _(),x("div",null,[e(we),e(G,{shadow:"always","body-style":{padding:"20px"}},{default:a(()=>[J(e(i,{type:"primary",size:"default",onClick:P,disabled:!r(L).c3Id},{default:a(()=>n[2]||(n[2]=[$(" 添加SPU ")])),_:1},8,["disabled"]),[[Q,r(o)===0]]),J(e(O,{data:r(s),border:"",stripe:"",style:{margin:"20px 0"},"header-cell-style":{textAlign:"center"},"cell-style":{textAlign:"center"}},{default:a(()=>[e(u,{type:"index",label:"序号",width:"80px"}),e(u,{prop:"spuName",label:"SPU名称"}),e(u,{prop:"description",label:"SPU描述"}),e(u,{label:"操作"},{default:a(y=>[e(i,{title:"添加SKU",type:"success",size:"default",icon:"Plus",onClick:c=>ee(y)},null,8,["onClick"]),e(i,{title:"编辑SPU",type:"primary",size:"default",icon:"Edit",onClick:c=>te(y)},null,8,["onClick"]),e(i,{title:"SPU详情",type:"warning",size:"default",icon:"InfoFilled",onClick:c=>X(y.row)},null,8,["onClick"]),e(A,{title:`你确认要删除${y.row.spuName}吗？`,onConfirm:c=>w(y.row.id)},{reference:a(()=>[e(i,{title:"删除SPU",type:"danger",size:"default",icon:"Delete"})]),_:2},1032,["title","onConfirm"])]),_:1}),e(C,{onSizeChange:V,onCurrentChange:k,"page-sizes":[3,5,7,9],"page-size":r(D),layout:"prev, pager, next, jumper, -> , sizes, total",total:r(z),background:""},{default:a(()=>n[3]||(n[3]=[$(' :pager-count="7"> ')])),_:1},8,["page-size","total"])]),_:1},8,["data"]),[[Q,r(o)===0]]),J(e(Fe,{ref_key:"spuFormRef",ref:N,onChangeScene:M},null,512),[[Q,r(o)===1]]),J(e($e,{ref_key:"skuFormRef",ref:U,onChangeScene:M},null,512),[[Q,r(o)===2]])]),_:1}),e(B,{title:"SPU详情",modelValue:r(h),"onUpdate:modelValue":n[0]||(n[0]=y=>H(h)?h.value=y:h=y),onClose:n[1]||(n[1]=y=>H(h)?h.value=!1:h=!1)},{default:a(()=>[e(O,{data:r(W),border:"",stripe:""},{default:a(()=>[e(u,{prop:"skuName",label:"SKU名字"}),e(u,{prop:"price",label:"SKU价格(元)"}),e(u,{prop:"weight",label:"SKU重量(g)"}),e(u,{label:"SKU图片"},{default:a(y=>[e(E,{style:{width:"100px",height:"100px"},src:y.row.skuDefaultImg},null,8,["src"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}});export{Te as default};
